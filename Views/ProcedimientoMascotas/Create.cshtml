@model Veterinaria.Web.Models.ProcedimientoMascotaCreateVm

@{
    ViewData["Title"] = "Nuevo Procedimiento de Mascota";
}

<h2 class="mb-3">@ViewData["Title"]</h2>

<form asp-action="Create" method="post" class="card p-3">
    @Html.AntiForgeryToken()
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

    <!-- ===== Procedimiento / Servicio ===== -->
    <div class="mb-3">
        <label for="ProcedimientoId" class="form-label">Tipo de consulta / Procedimiento</label>
        
        <select asp-for="ServicioId" id="ProcedimientoId" class="form-select">
            <option value="">-- Seleccione un servicio --</option>
        </select>

        <span asp-validation-for="ServicioId" class="text-danger"></span>


        <div class="form-text" id="PrecioInfo">Precio: —</div>
    </div>

    <!-- IVA -->
    <div class="mb-3">
        <label asp-for="IvaPorcentaje" class="form-label"></label>
        <input asp-for="IvaPorcentaje" class="form-control" type="number" step="0.01" min="0" max="100" />
        <span class="form-text">Se aplica al total mostrado (por defecto 13%).</span>
        <span asp-validation-for="IvaPorcentaje" class="text-danger"></span>
    </div>

    <!-- Peso (solo cirugías por kg) -->
    <div class="mb-3" id="PesoGroup" style="display:none;">
        <label asp-for="PesoKg" class="form-label">Peso de la mascota (kg)</label>
        <input asp-for="PesoKg" class="form-control" type="number" step="0.01" min="0" id="PesoKg" placeholder="Ej. 8.50" />
        <span asp-validation-for="PesoKg" class="text-danger"></span>
    </div>

    <!-- Hidden para POST (se rellenan vía JS) -->
    <input asp-for="Tipo" type="hidden" id="Tipo" />
    <input asp-for="Codigo" type="hidden" id="Codigo" />
    <input asp-for="Precio" type="hidden" id="Precio" />

    <!-- ===== Cliente ===== -->
    <div class="mb-3">
        <label asp-for="ClienteId" class="form-label"></label>
        <select asp-for="ClienteId" class="form-select" asp-items="Model.Clientes" id="ClienteId">
            <option value="">-- Seleccione un cliente --</option>
        </select>
        <span asp-validation-for="ClienteId" class="text-danger"></span>
    </div>

    <!-- ===== Mascota (dependiente de Cliente) ===== -->
    <div class="mb-3">
        <label asp-for="MascotaId" class="form-label"></label>
        <select asp-for="MascotaId" class="form-select" id="MascotaId" data-selected="@Model.MascotaId">
            <option value="">-- Seleccione una mascota --</option>
        </select>
        <span asp-validation-for="MascotaId" class="text-danger"></span>
    </div>

    <!-- ===== Veterinario ===== -->
    <div class="mb-3">
        <label asp-for="EmpleadoId" class="form-label"></label>
        <select asp-for="EmpleadoId" class="form-select" asp-items="Model.Veterinarios" id="EmpleadoId">
            <option value="">-- Seleccione un veterinario --</option>
        </select>
        <span asp-validation-for="EmpleadoId" class="text-danger"></span>
    </div>

    <!-- Estado (valores permitidos por CK_Citas_Estado) -->
    <div class="mb-3">
        <label for="Estado" class="form-label">Estado</label>
        <select name="Estado" id="Estado" class="form-select">
            <option value="Pendiente" selected>Pendiente</option>
            <option value="Completada">Completada</option>
            <option value="Cancelada">Cancelada</option>
        </select>
        <div class="form-text">Solo se aceptan: Pendiente, Completada o Cancelada.</div>
    </div>

    <!-- Notas opcionales -->
    <div class="mb-3">
        <label asp-for="Notas" class="form-label">Notas</label>
        <textarea asp-for="Notas" class="form-control" rows="2" placeholder="Observaciones..."></textarea>
    </div>

    <div class="d-flex gap-2">
        <button type="submit" class="btn btn-success">Guardar</button>
        <a asp-action="Index" class="btn btn-secondary">Cancelar</a>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
          const API = 'https://localhost:7195';

          const ddlProc    = document.getElementById('ProcedimientoId');  // <select asp-for="ServicioId">
          const precioInfo = document.getElementById('PrecioInfo');
          const ivaInput   = document.getElementById('IvaPorcentaje');    // <select> o <input> 13 por defecto
          const pesoGroup  = document.getElementById('PesoGroup');        // div que contiene el input de peso
          const pesoInput  = document.getElementById('PesoKg');           // <input type="number" ...>

          // Mantén estos si ya los usas; no son estrictamente necesarios para /api/citas
          const hidPrecio  = document.getElementById('Precio');           // hidden opcional (solo UI)

          let servicios = []; // [{servicioId, nombre, precioBase, activo}]

          const fmtCRC = new Intl.NumberFormat('es-CR', { style: 'currency', currency: 'CRC' });
          const norm = s => (s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();
          const esPorKg = n => { n = norm(n); return n.includes('cirugia menor') || n.includes('cirugia mayor'); };

          function setPrecioUI(item) {
            if (!item) {
              precioInfo.textContent = 'Precio: —';
              pesoGroup.style.display = 'none';
              if (hidPrecio) hidPrecio.value = '';
              return;
            }
            const base = Number(item.precioBase || 0);
            const porKg = esPorKg(item.nombre);
            pesoGroup.style.display = porKg ? '' : 'none';

            let total = base;
            if (porKg) {
              const kg = Number(pesoInput?.value || 0);
              total = base * (isNaN(kg) ? 0 : kg);
            }
            const iva = Number(ivaInput?.value || 0) / 100;
            const totalConIva = total * (1 + iva);

            precioInfo.textContent = `Precio: ${fmtCRC.format(base)}${porKg ? ' × kg' : ''} — Total c/IVA: ${fmtCRC.format(totalConIva)}`;
            if (hidPrecio) hidPrecio.value = total.toFixed(2); // opcional, el POST a /api/citas no lo necesita
          }

          async function loadServicios() {
            ddlProc.innerHTML = '';
            ddlProc.add(new Option('Cargando servicios...', ''));
            ddlProc.disabled = true;

                    // ------ Mascotas dependientes de Cliente ------
        const ddlCliente = document.getElementById('ClienteId');
        const ddlMascota = document.getElementById('MascotaId');
        const selectedMascota = ddlMascota?.dataset.selected;

        function setMascotasLoading(msg) {
          ddlMascota.innerHTML = "";
          ddlMascota.add(new Option(msg, ""));
          ddlMascota.disabled = true;
        }
        function setMascotasEmpty(msg) {
          ddlMascota.innerHTML = "";
          ddlMascota.add(new Option(msg, ""));
          ddlMascota.disabled = true;
        }
        function setMascotasOptions(mascotas, preselect) {
          ddlMascota.innerHTML = "";
          ddlMascota.add(new Option("-- Seleccione una mascota --", ""));
          for (const m of mascotas) {
            const det = [m.especie, m.raza].filter(Boolean).join(" · ");
            const label = det ? `${m.nombre ?? "(Sin nombre)"} — ${det}` : (m.nombre ?? "(Sin nombre)");
            ddlMascota.add(new Option(label, m.id));
          }
          ddlMascota.disabled = false;
          if (preselect) ddlMascota.value = preselect;
        }

        async function loadMascotas(clienteId, preselect = null) {
          if (!clienteId) {
            setMascotasEmpty("— Seleccione un cliente primero —");
            return;
          }
          setMascotasLoading("Cargando mascotas...");
          try {
            const url = `${API}/api/Mascotas?clienteId=${encodeURIComponent(clienteId)}&nocache=${Date.now()}`;
            const resp = await fetch(url, { headers: { accept: "application/json, text/plain" } });
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            const data = await resp.json(); // aunque el API responda text/plain
            if (!Array.isArray(data) || data.length === 0) {
              setMascotasEmpty("— No hay mascotas para este cliente —");
              return;
            }
            setMascotasOptions(data, preselect);
          } catch (err) {
            console.error("Error cargando mascotas:", err);
            setMascotasEmpty("— Error cargando mascotas —");
          }
        }

        ddlCliente.addEventListener('change', (e) => {
          loadMascotas(e.target.value);
        });

        // Extiende tu DOMContentLoaded actual para precargar mascotas si ya hay cliente seleccionado
        document.addEventListener('DOMContentLoaded', () => {
          // ya tenías: loadServicios();
          const currentCliente = ddlCliente?.value;
          if (currentCliente) loadMascotas(currentCliente, selectedMascota);
          else setMascotasEmpty("— Seleccione un cliente primero —");
        });

            try {
                const resp = await fetch(`${API}/api/servicios?soloActivos=true`, {
                    headers: { accept: 'application/json, text/plain' }
                });
              const txt = await resp.text();
              const data = JSON.parse(txt);

              servicios = (Array.isArray(data) ? data : []).map(x => ({
                servicioId: Number(x.servicioId ?? x.ServicioId),
                nombre:     x.nombre ?? x.Nombre ?? '(Sin nombre)',
                precioBase: Number(x.precioBase ?? x.PrecioBase ?? 0),
                activo:     Boolean(x.activo ?? x.Activo ?? true)
              }));

              ddlProc.innerHTML = '';
              ddlProc.add(new Option('-- Seleccione un servicio --', ''));
              servicios
                .filter(s => s.activo)
                .sort((a,b) => a.nombre.localeCompare(b.nombre))
                .forEach(s => {
                  const etiqueta = `${s.nombre} — ${fmtCRC.format(s.precioBase)}${esPorKg(s.nombre) ? ' /kg' : ''}`;
                  ddlProc.add(new Option(etiqueta, String(s.servicioId))); // VALUE = ServicioId (int)
                });

              ddlProc.disabled = false;
            } catch (err) {
              console.error('Error cargando servicios:', err);
              ddlProc.innerHTML = '';
              ddlProc.add(new Option('— Error cargando servicios —', ''));
              ddlProc.disabled = true;
            }
          }

          ddlProc.addEventListener('change', () => {
            const id = Number(ddlProc.value || 0);
            const item = servicios.find(x => x.servicioId === id);
            setPrecioUI(item);
          });

          ivaInput?.addEventListener('input', () => {
            const id = Number(ddlProc.value || 0);
            const item = servicios.find(x => x.servicioId === id);
            setPrecioUI(item);
          });

          pesoInput?.addEventListener('input', () => {
            const id = Number(ddlProc.value || 0);
            const item = servicios.find(x => x.servicioId === id);
            setPrecioUI(item);
          });

          document.addEventListener('DOMContentLoaded', loadServicios);
        })();
    </script>

}
